---
title: "How to succeed in my exam"
tags: ["education", "teaching", "R"]
comments: true
---


## The question

The student is provided with an object of class
[`SummarizedExperiment`](http://www.biocondoctor.org/packages/SummarizedExperiment),
called `se`, that contains (part of the) data from *The effect of
upper-respiratory infection on transcriptomic changes in the CNS* by
[Blackmore *et al.*
(2017)](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5544260/):

> **Purpose**: The goal of this study was to determine the effect of an
> upper-respiratory infection on changes in RNA transcription occurring
> in the cerebellum and spinal cord post infection.
>
> (The provided data here only contain the cerebellum samples.)
>
> **Methods**: Gender matched eight week old C57BL/6 mice were
> inoculated saline or with Influenza A by intranasal route and
> transcriptomic changes in the cerebellum and spinal cord tissues were
> evaluated by RNA-seq at days 0 (non-infected), 4 and 8.

The student is asked to visualie the gene expression distributions in
each sample using violin plots and to colour these based on the
infection statues, *Influenza A* or *Non-Infected*.

## Pre-requisites

There are several ways to produce this visualisation. Here, the
students have learnt to use the *tidyverse* and `SummarizedExperiment`
objects, and not (yet) with base plotting. The goal of this question
is for them to demonstrate they are familiar with the latter, can
extract different parts of the object, know how to transform and
combine them using standard `dplyr` functions and eventually visualise
them using `ggplot2`.

## A conceptual solution

The main trap many students fall into is to start writing code before
having thought about how to answer the question, and thus end up
wasting precious time with random trial and error strategy. This is
somehow amplified by copying code that apparently (at least) partially
addresses the question. This seed code comes from the lecture notes
and past exam questions, that the students can have with them during
the exam. In my eyes, this trial-and-error approach equates to
randomly taking buses until one brings them to they expected
destination by sheer luck... which is extremely unlikely when several
buses are needed to reach that destination.

My suggestion is to first think about how to answer the question
before actually answering. As a way of focusing on the how, let's
first sketch out an plan, starting from the end.

1. Based on the question, I anticipate to have a figure with samples
   along the x axis and expression values along the y axis, with
   violin plots of different colours based on the infection status. I
   typically recommend students to have a go with pen and paper and
   draw such a hypothetical figure.

2. We can already easily write code that produces such a figure,
   assuming that we have a long `data.frame` or `tibble` named `x`,
   that contains three columns, namely `expression` with the
   expression values, `sample` containing the sample names and
   `infection`, with the *'Influenza A* and *Non-Infected* sample
   infection status.

   ```r
   ggplot(x, aes(x = sample, y = expression, fill = infection)) +
       geom_violin()
   ```

3. From the previous step, we know we will need the expression data,
   the sample names, and their respective infection status. Even
   without looking at the actual data, we know how to extract these:
   `assay(se)` gives us the expression data, with column names
   referring to the sample, and `colData(se)$infection` (or simply
   `se$infection`) provides the infection status (assuming that it's
   encoded by the `infection` column variable).

4. We also know that `assay(se)` returns the data in a wide format,
   with genes along the rows and samples along the columns, but that
   to produce the figure sketched out in step 1 using `ggplot()` in
   step 2, we will need it in long format. We know that we can use
   `pivot_longer()` to do that:

   ```r
   pivot_longer(assay(se),
                names_to = "sample",
                values_to = "expression",
                everything())
   ```

   The code above will fail because `assay(se)` returns a matrix, but
   `pivot_longer()` expects a `data.frame`, as mentioned above. We
   thus need to convert the matrix as shown below:

   ```r
   pivot_longer(as.data.frame(assay(se)),
                names_to = "sample",
                values_to = "expression",
                everything())
   ```

   This will generate something quite close to what we need, a table
   with the `expression` and `sample` columns. We will need the
   `infection` status.

5. We know from step 3 that the infection status is available from the
   `colData`, that we need to merge to our long two-column table from
   step 4. This can be done with `full_join()`. Below, I use the pipe
   operator to continue the chunk written above.

   ```r
   pivot_longer(as.data.frame(assay(se)),
                names_to = "sample",
                values_to = "expression",
                everything()) %>%
       full_join(colData(se))
   ```

   There are two errors in the code above. First, we need to convert
   the `DataFrame` returned by `colData(se)` to a `data.frame` (or
   `tibble`). This is easy. The second (likely) error lies in the
   variable names used to join the tables (`full_join()`'s `by`
   argument). If we have a `sample` variable in the `colData` that
   contains sample names, the join will succeed. Otherwise, we will
   need to defined the vector of variables to join by using `by`. We
   can also create that variable on the fly using
   `tibble::rownames_to_column()` knowing that the rownames of
   `colData` match the sample names (by definition), and set it to
   `sample`.

   ```r
   pivot_longer(as.data.frame(assay(se)),
                names_to = "sample",
                values_to = "expression",
                everything()) %>%
       full_join(rownames_to_column(as.data.frame(colData(se)),
                                    var = "sample"))
   ```

## Bringing it all together

In the previous section, I already wrote syntactically correct code,
ironing out smaller issues such as conversion to `data.frame` and
variable matching. I haven't run the code, but I'm quite confident it
should work with my `se` object, as long as the infection status is
encoded as `infection` in the `colData`. A conceptual solution without
these details would already earn students a very decent grade. The
effort to produce the actual figure and earn full marks is, in my
opinion, relatively minor, once the path to the answer is mapped out.
Referring back to my travelling by bus illustration above, this
conceptual solution is similar to having the bus names, their
respective stop, and possibly even times mapped out - all that is left
is to execute the actual travel plan.

```r
pivot_longer(as.data.frame(assay(se)),
             names_to = "sample",
             values_to = "expression",
             everything()) %>%
    full_join(rownames_to_column(as.data.frame(colData(se)),
                                 var = "sample")) %>%
    ggplot(aes(x = sample, y = expression, fill = infection)) +
    geom_violin()
```

## An alternative solution

There is of course a much more direct solution, using boxplot on the
assay matrix and setting the `col` argument with the infection state
vector. This solution is one that student would most likely implement
after following the second year of the bioinformatics cursus. In the
[first year](http://bit.ly/WSBIM1207), we start with general data
manipulation and visualisation using the *tidyverse*. Omics data and
`SummarizedExperiment` only come later, as a preparation for the
[second](http://bit.ly/WSBIM1322) and [third](http://bit.ly/WSBIM2122)
years.
